version: 2.1
orbs:
  slack: circleci/slack@4.1
executors:
  golang-executor:
    docker:
      - image: gcr.io/gcr-for-testing/golang:1.24.9

  x86-machine-executor:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true

  arm-machine-executor:
    machine:
      image: ubuntu-2204:current
    resource_class: arm.medium
aliases:
  - &notify_slack_on_fail
    slack/notify:
      channel: 'C056RL4BXG9' #status-go channel
      event: fail
      template: basic_fail_1
  
  # Common environment variables for integration tests (shared between x86 and ARM)
  # NOTE: TEST_RESOURCES must match the attach_workspace path below - it tells the Makefile
  # where to find resources on the host machine so it can mount them into Docker containers
  - &integration_test_env
    TEST_RESOURCES: "/home/circleci/resources/"
    ARANGODB: << pipeline.parameters.arangodbImage >>
    GOIMAGE: << pipeline.parameters.goImage >>
    ALPINE_IMAGE: << pipeline.parameters.alpineImage >>
    STARTER: << pipeline.parameters.starterImage >>
    ENABLE_DATABASE_EXTRA_FEATURES: << parameters.enable-extra-db-features >>
    TEST_DISALLOW_UNKNOWN_FIELDS: false
    VERBOSE: 1

parameters:
  goImage:
    type: string
    default: "gcr.io/gcr-for-testing/golang:1.24.9"
  arangodbImage:
    type: string
    default: "public.ecr.aws/b0b8h2r4/enterprise-preview:2025-12-01-devel-d759089-amd64"
  alpineImage:
    type: string
    default: "gcr.io/gcr-for-testing/alpine:3.21"
  starterImage:
    type: string
    default: "arangodb/arangodb-starter:latest"

commands:
  run-test-if-pr:
    description: "Run a test command only if this is a pull request"
    parameters:
      test-command:
        type: string
    steps:
      - run:
          name: Run integration tests
          command: |
            if [ -z "$CIRCLE_PULL_REQUEST" ]; then
              echo "This is not a pull request. Skipping..."
              exit 0
            fi
            << parameters.test-command >>

jobs:

  check-code:
    executor: golang-executor
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - run: make tools
      - run: make linter

  run-unit-tests:
    executor: x86-machine-executor
    steps:
      - checkout
      - run: make run-unit-tests
    environment:
      GOIMAGE: << pipeline.parameters.goImage >>

  download-demo-data:
    executor: x86-machine-executor
    steps:
      - checkout
      - run: mkdir -p $HOME/resources
      - run:
          name: Download itzpapalotl demo foxx service
          command: |
            if [ -z "$CIRCLE_PULL_REQUEST" ]; then
              echo "This is not a pull request. Skipping download..."
              exit 0
            fi
            if ! [ -f "$HOME/resources/itzpapalotl-v1.2.0.zip" ]; then
              curl -L0 -o $HOME/resources/itzpapalotl-v1.2.0.zip \
                "https://github.com/arangodb-foxx/demo-itzpapalotl/archive/v1.2.0.zip"
            fi
      - persist_to_workspace:
          root: /home/circleci
          paths:
            - resources


  # ----------------------------------------
  # UNIFIED INTEGRATION TEST JOB X86
  # ----------------------------------------
  run-integration-tests:
    executor: x86-machine-executor
    parameters:
      test-to-run:
        type: string
      enable-extra-db-features:
        type: boolean
        default: false
    steps:
      - checkout
      # Attach workspace to download demo data from download-demo-data job
      # NOTE: This path must match TEST_RESOURCES env var - Makefile uses TEST_RESOURCES
      # to mount this directory into Docker containers
      - attach_workspace:
          at: /home/circleci/resources
      - run:
          name: Ensure resources directory exists
          command: mkdir -p $HOME/resources
      - run-test-if-pr:
          test-command: make << parameters.test-to-run >>
    environment:
      <<: *integration_test_env

  # ----------------------------------------
  # ARM INTEGRATION TEST JOB
  # ----------------------------------------
  run-integration-tests-arm:
    executor: arm-machine-executor
    parameters:
      test-to-run:
        type: string
      enable-extra-db-features:
        type: boolean
        default: false
    steps:
      - checkout
      # Attach workspace to download demo data from download-demo-data job
      # NOTE: This path must match TEST_RESOURCES env var - Makefile uses TEST_RESOURCES
      # to mount this directory into Docker containers
      - attach_workspace:
          at: /home/circleci/resources
      - run:
          name: Ensure resources directory exists
          command: mkdir -p $HOME/resources
      - run:
          name: Set platform-specific environment variables
          command: |
            echo 'export DOCKER_PLATFORM="--platform linux/arm64"' >> $BASH_ENV
            echo 'export DOCKER_BUILD_PLATFORM="--platform linux/arm64"' >> $BASH_ENV
      - run-test-if-pr:
          test-command: make << parameters.test-to-run >>
    environment:
      <<: *integration_test_env

  vulncheck:
    executor: golang-executor
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - run: make tools
      - run: make vulncheck
      - *notify_slack_on_fail

workflows:
  version: 2

  # Default workflow
  run_tests:
    jobs:
      - check-code
      - run-unit-tests:
          requires:
            - check-code
      - download-demo-data:
          requires:
            - run-unit-tests

      # ========================
      # V1 Tests x86
      # ========================
      - run-integration-tests:
          name: Test V1 cluster
          requires:
            - download-demo-data
          test-to-run: run-tests-cluster

      - run-integration-tests:
          name: Test V1 single
          requires:
            - download-demo-data
          test-to-run: run-tests-single

      # ========================
      # V2 Tests x86
      # ========================
      - run-integration-tests:
          name: Test V2 cluster
          requires:
            - download-demo-data
          test-to-run: run-v2-tests-cluster

      - run-integration-tests:
          name: Test V2 cluster - DB extra features (compression)
          requires:
            - download-demo-data
          test-to-run: run-v2-tests-cluster
          enable-extra-db-features: true

      - run-integration-tests:
          name: Test V2 single
          requires:
            - download-demo-data
          test-to-run: run-v2-tests-single

      # ========================
      # V2 Tests ARM
      # ========================
      - run-integration-tests-arm:
          name: Test V2 cluster (ARM)
          requires:
            - download-demo-data
          test-to-run: run-v2-tests-cluster

      # - run-integration-tests-arm:
      #     name: Test V2 cluster - DB extra features (compression) (ARM)
      #     requires:
      #       - download-demo-data
      #     test-to-run: run-v2-tests-cluster
      #     enable-extra-db-features: true

      - run-integration-tests-arm:
          name: Test V2 single (ARM)
          requires:
            - download-demo-data
          test-to-run: run-v2-tests-single

  # Weekly vulnerability check
  weekly_vulncheck:
    jobs:
      - vulncheck:
          context:
            - slack
    triggers:
      - schedule:
          # 6:00 on every Monday
          cron: 0 6 * * 1
          filters:
            branches:
              only: master